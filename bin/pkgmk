#!/bin/sh
# pkgmk — fluxo único estilo makepkg para XBPS
set -e

WORKDIR="$PWD"
SRCDIR="$WORKDIR/src"
PKGDIR="$WORKDIR/pkg"
REPODIR="$WORKDIR/repo"
ARCH="$(uname -m)"

die() { echo "erro: $*" >&2; exit 1; }
msg() { echo "==> $*"; }

# -------- carregar PKGFILE --------
load_pkgfile() {
  [ -f PKGFILE ] || die "PKGFILE não encontrado"
  . ./PKGFILE

  : "${pkgname:?}"
  : "${pkgver:?}"
  : "${pkgrel:?}"
  : "${pkgdesc:?}"
  : "${license:?}"
  : "${source:?}"
}

# -------- checagens --------
check_funcs() {
  command -v build   >/dev/null || die "função build() ausente"
  command -v package >/dev/null || die "função package() ausente"
}

check_makedepends() {
  for d in $makedepends; do
    command -v "$d" >/dev/null 2>&1 || die "makedependency ausente: $d"
  done
}

# -------- source --------
fetch() {
  mkdir -p "$SRCDIR"
  cd "$SRCDIR"
  file="${source##*/}"
  [ -f "$file" ] || curl -L -o "$file" "$source"
}

extract() {
  cd "$SRCDIR"
  tar xf "${source##*/}"
  cd "${pkgname}-${pkgver}" || die "diretório source inválido"
}

# -------- fluxo --------
run_all() {
  msg "Lint"
  check_funcs
  check_makedepends

  msg "Fetch"
  fetch

  msg "Extract"
  extract

  if command -v prepare >/dev/null; then
    msg "Prepare"
    prepare
  fi

  msg "Build"
  build

  msg "Package (staging)"
  mkdir -p "$PKGDIR"
  package

  msg "Create XBPS"
  mkdir -p "$REPODIR"

  xbps-create \
    -A "$ARCH" \
    -n "${pkgname}-${pkgver}_${pkgrel}" \
    -s "$pkgdesc" \
    -l "$license" \
    ${depends:+-D "$depends"} \
    "$PKGDIR"

  mv "${pkgname}-${pkgver}_${pkgrel}.xbps" "$REPODIR/"
  xbps-rindex -a "$REPODIR/${pkgname}-${pkgver}_${pkgrel}.xbps"

  msg "Done"
}

clean() {
  rm -rf "$SRCDIR" "$PKGDIR" "$REPODIR"
}

usage() {
  echo "uso: pkgmk [-c]"
}

# -------- main --------
load_pkgfile

case "$1" in
  "" ) run_all ;;
  -c ) clean ;;
  *  ) usage; exit 1 ;;
esac

