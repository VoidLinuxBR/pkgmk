#!/bin/sh
# pkgmk — makepkg-like tool for XBPS
set -e

# diretórios
WORKDIR="$PWD"
SRCDIR="$WORKDIR/src"
PKGDIR="$WORKDIR/pkg"
REPODIR="$WORKDIR/repo"
ARCH="$(uname -m)"

die() { echo "erro: $*" >&2; exit 1; }
msg() { echo "==> $*"; }

# carrega PKGFILE
load_pkgfile() {
  [ -f PKGFILE ] || die "PKGFILE não encontrado"
  . ./PKGFILE

  : "${pkgname:?}"
  : "${pkgver:?}"
  : "${pkgrel:?}"
  : "${pkgdesc:?}"
  : "${license:?}"
  : "${source:?}"
}

# baixa source
fetch() {
  mkdir -p "$SRCDIR"
  cd "$SRCDIR"
  file="${source##*/}"
  [ -f "$file" ] || curl -L -o "$file" "$source"
}

# extrai source
extract() {
  cd "$SRCDIR"
  tar xf "${source##*/}"
  cd "${pkgname}-${pkgver}" || die "diretório source inválido"
}

# fases
run_prepare() { command -v prepare >/dev/null && prepare; }
run_build()   { command -v build   >/dev/null || die "build() ausente"; build; }
run_package() { command -v package >/dev/null || die "package() ausente"; package; }

# lint básico
lint() {
  command -v build   >/dev/null || die "função build() ausente"
  command -v package >/dev/null || die "função package() ausente"
}

# fluxo completo (default)
run_all() {
  msg "Lint"
  lint

  msg "Fetch"
  fetch

  msg "Extract"
  extract

  msg "Prepare"
  run_prepare || true

  msg "Build"
  run_build

  msg "Package (staging)"
  mkdir -p "$PKGDIR"
  run_package

  msg "Create XBPS"
  mkdir -p "$REPODIR"

  xbps-create \
    -A "$ARCH" \
    -n "${pkgname}-${pkgver}_${pkgrel}" \
    -s "$pkgdesc" \
    -l "$license" \
    ${depends:+-D "$depends"} \
    "$PKGDIR"

  mv "${pkgname}-${pkgver}_${pkgrel}.xbps" "$REPODIR/"

  msg "Sign repository"
  xbps-rindex -a "$REPODIR/${pkgname}-${pkgver}_${pkgrel}.xbps"

  msg "Done"
}

clean() {
  rm -rf "$SRCDIR" "$PKGDIR" "$REPODIR"
}

usage() {
  cat <<EOF
uso: pkgmk [opção]

Sem opção:
  executa fluxo completo (lint + build + package + sign)

Opções:
  -c   clean
  -h   ajuda
EOF
}

# -------- main --------
load_pkgfile

case "$1" in
  "" ) run_all ;;
  -c ) clean ;;
  -h ) usage ;;
  *  ) usage; exit 1 ;;
esac
