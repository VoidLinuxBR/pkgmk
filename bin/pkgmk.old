#!/bin/sh
set -e

cmd="$1"

load_pkgfile() {
  [ -f Pkgfile ] || { echo "Erro: Pkgfile não encontrado"; exit 1; }
  . ./Pkgfile
}

fetch() {
  mkdir -p src
  cd src
  [ -f "${source##*/}" ] || curl -LO "$source"
}

extract() {
  tar xf "${source##*/}"
  cd "${pkgname}-${pkgver}"
}

case "$cmd" in
  build)
    load_pkgfile
    fetch
    extract
    prepare 2>/dev/null || true
    build
    ;;
  package)
    load_pkgfile
    mkdir -p "$PKGDIR"
    cd "src/${pkgname}-${pkgver}"
    package
    ;;
  clean)
    rm -rf src pkg dist
    ;;
  lint)
    load_pkgfile
    : "${pkgname:?}"
    : "${pkgver:?}"
    : "${license:?}"
    command -v build >/dev/null || {
      echo "Erro: função build() ausente"
      exit 1
    }
    command -v package >/dev/null || {
      echo "Erro: função package() ausente"
      exit 1
    }
    ;;
  *)
    echo "Uso: pkgmk {build|package|clean|lint}"
    exit 1
esac
