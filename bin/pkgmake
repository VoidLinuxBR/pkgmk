#!/bin/sh
# pkgmake — makepkg-like tool for XBPS (package-only)
set -e

WORKDIR="$PWD"
SRCDIR="$WORKDIR/src"
PKGDIR="$WORKDIR/pkg"
OUTDIR="$WORKDIR"
ARCH="$(uname -m)"

SYNCDEPS=0
SIGNPKG=0
PRIVKEY=""

die() { echo "erro: $*" >&2; exit 1; }
msg() { echo "==> $*"; }

load_pkgfile() {
  [ -f PKGFILE ] || die "PKGFILE não encontrado"
  . ./PKGFILE

  : "${pkgname:?}"
  : "${pkgver:?}"
  : "${pkgrel:?}"
  : "${pkgdesc:?}"
  : "${license:?}"
  : "${source:?}"
}

sync_deps() {
  [ "$SYNCDEPS" -eq 1 ] || return 0
  pkgs="$makedepends $depends"
  [ -z "$pkgs" ] && return 0
  sudo xbps-install -Sy $pkgs
}

lint() {
  command -v build   >/dev/null || die "função build() ausente"
  command -v package >/dev/null || die "função package() ausente"
}

fetch() {
  mkdir -p "$SRCDIR"
  cd "$SRCDIR"
  file="${source##*/}"
  [ -f "$file" ] || curl -L -o "$file" "$source"
}

extract() {
  cd "$SRCDIR"
  tar xf "${source##*/}"
  cd "${pkgname}-${pkgver}" || die "diretório source inválido"
}

find_privkey() {
  [ -n "$PRIVKEY" ] && return 0

  for k in "$HOME/.gnupg/privkey.pem" "$HOME/.gnupg/private.pem"; do
    [ -f "$k" ] && { PRIVKEY="$k"; return 0; }
  done

  die "chave privada não encontrada (use --privkey ou coloque privkey.pem/private.pem em ~/.gnupg)"
}

run_all() {
  msg "Lint"
  lint

  sync_deps

  msg "Fetch"
  fetch

  msg "Extract"
  extract

  if command -v prepare >/dev/null; then
    msg "Prepare"
    prepare
  fi

  msg "Build"
  build

  msg "Package (staging)"
  mkdir -p "$PKGDIR"
  package

  msg "Create XBPS"
  xbps-create \
    -A "$ARCH" \
    -n "${pkgname}-${pkgver}_${pkgrel}" \
    -s "$pkgdesc" \
    -l "$license" \
    ${depends:+-D "$depends"} \
    "$PKGDIR"

  PKGFILE_OUT="${pkgname}-${pkgver}_${pkgrel}.${ARCH}.xbps"
  mv "$PKGFILE_OUT" "$OUTDIR/"

  if [ "$SIGNPKG" -eq 1 ]; then
    find_privkey
    msg "Sign package"
    xbps-rindex --sign-pkg --privkey "$PRIVKEY" "$OUTDIR/$PKGFILE_OUT"
  fi

  msg "Done: $OUTDIR/$PKGFILE_OUT"
}

clean() {
  rm -rf "$SRCDIR" "$PKGDIR"
}

usage() {
  cat <<EOF
uso: pkgmake [-s] [--sign [--privkey KEY]] [-c]

-s              instalar depends e makedepends
--sign          assinar o pacote resultante (.sig2)
--privkey KEY   chave RSA PEM (default: ~/.gnupg/privkey.pem ou private.pem)
-c              limpar diretórios gerados
EOF
}

while [ $# -gt 0 ]; do
  case "$1" in
    -s) SYNCDEPS=1; shift ;;
    --sign) SIGNPKG=1; shift ;;
    --privkey) PRIVKEY="$2"; shift 2 ;;
    -c) clean; exit 0 ;;
    -h|--help) usage; exit 0 ;;
    *) die "opção inválida: $1" ;;
  esac
done

load_pkgfile
run_all

