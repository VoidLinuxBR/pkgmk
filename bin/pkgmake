#!/bin/sh
# pkgmake — makepkg-like tool for XBPS (package + local repo)
set -e

WORKDIR="$PWD"
SRCDIR="$WORKDIR/src"
PKGDIR="$WORKDIR/pkg"
REPODIR="$WORKDIR/repo"
ARCH="$(uname -m)"

SYNCDEPS=0
SIGNPKG=0
INSTALLPKG=0
FORCEPKG=0
PRIVKEY=""

die() { echo "erro: $*" >&2; exit 1; }
msg() { echo "==> $*"; }

load_pkgfile() {
  [ -f PKGFILE ] || die "PKGFILE não encontrado"
  . ./PKGFILE
  : "${pkgname:?}"
  : "${pkgver:?}"
  : "${pkgrel:?}"
  : "${pkgdesc:?}"
  : "${license:?}"
  : "${source:?}"
}

sync_deps() {
  [ "$SYNCDEPS" -eq 1 ] || return 0
  pkgs="$makedepends $depends"
  [ -z "$pkgs" ] && return 0
  sudo xbps-install -Sy $pkgs
}

lint() {
  command -v build   >/dev/null || die "função build() ausente"
  command -v package >/dev/null || die "função package() ausente"
}

fetch() {
  mkdir -p "$SRCDIR"
  cd "$SRCDIR"
  file="${source##*/}"
  [ -f "$file" ] || curl -L -o "$file" "$source"
}

extract() {
  cd "$SRCDIR"
  tar xf "${source##*/}"
  cd "${pkgname}-${pkgver}" || die "diretório source inválido"
}

find_privkey() {
  [ -n "$PRIVKEY" ] && return 0
  for k in "$HOME/.gnupg/privkey.pem" "$HOME/.gnupg/private.pem"; do
    [ -f "$k" ] && { PRIVKEY="$k"; return 0; }
  done
  die "chave privada não encontrada (use --privkey ou ~/.gnupg/privkey.pem|private.pem)"
}

run_all() {
  msg "Lint"
  lint

  sync_deps

  msg "Fetch"
  fetch

  msg "Extract"
  extract

  if command -v prepare >/dev/null; then
    msg "Prepare"
    prepare
  fi

  msg "Build"
  build

  msg "Package (staging)"
  mkdir -p "$PKGDIR"
  package

  msg "Create XBPS"
  xbps-create \
    -A "$ARCH" \
    -n "${pkgname}-${pkgver}_${pkgrel}" \
    -s "$pkgdesc" \
    -l "$license" \
    "$PKGDIR"

  PKGFILE_OUT="${pkgname}-${pkgver}_${pkgrel}.${ARCH}.xbps"

  msg "Create local repo"
  mkdir -p "$REPODIR"
  mv "$PKGFILE_OUT" "$REPODIR/"

  if [ "$SIGNPKG" -eq 1 ]; then
    find_privkey
    msg "Sign package"
    xbps-rindex --sign-pkg --privkey "$PRIVKEY" "$REPODIR/$PKGFILE_OUT"
  fi

  msg "Update repodata"
  xbps-rindex -a "$REPODIR"/*.xbps

  msg "Done"

  if [ "$INSTALLPKG" -eq 1 ]; then
    msg "Install package"
    if [ "$FORCEPKG" -eq 1 ]; then
      sudo xbps-install -f -R "$REPODIR" -S "${pkgname}"
    else
      sudo xbps-install -R "$REPODIR" -S "${pkgname}"
    fi
  else
    msg "Install with:"
    msg "  sudo xbps-install -R $REPODIR -S ${pkgname}"
  fi
}

clean() {
  rm -rf "$SRCDIR" "$PKGDIR" "$REPODIR"
}

usage() {
  cat <<EOF
uso: pkgmake [-s] [-i] [-f] [--sign [--privkey KEY]] [-c]

-s, --syncdeps     instalar depends e makedepends
-i, --install      instalar pacote após build
-f, --force        sobrescrever pacote existente
--sign             assinar o pacote (.sig2)
--privkey KEY      chave RSA PEM
-c                 limpar diretórios gerados
EOF
}

while [ $# -gt 0 ]; do
  case "$1" in
    -s|--syncdeps) SYNCDEPS=1; shift ;;
    -i|--install) INSTALLPKG=1; shift ;;
    -f|--force) FORCEPKG=1; shift ;;
    --sign) SIGNPKG=1; shift ;;
    --privkey) PRIVKEY="$2"; shift 2 ;;
    -c) clean; exit 0 ;;
    -h|--help) usage; exit 0 ;;
    *) die "opção inválida: $1" ;;
  esac
done

load_pkgfile
run_all

